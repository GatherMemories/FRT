package com.awei.frt.utils;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.nio.file.*;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Stream;

/**
 * 文件操作工具类
 */
public class FileUtils {
    private static final Logger logger = LoggerFactory.getLogger(FileUtils.class);

    /**
     * 递归获取目录下所有文件
     */
    public static List<Path> getAllFiles(Path directory) throws IOException {
        List<Path> files = new ArrayList<>();
        try (Stream<Path> stream = Files.walk(directory)) {
            stream.filter(Files::isRegularFile)
                  .forEach(files::add);
        } catch (Exception e) {
            logger.warn("获取文件列表失败: {}", directory, e);
        }
        return files;
    }

    /**
     * 复制文件
     */
    public static Boolean copyFile(Path source, Path target) throws IOException {
        try {
            Files.createDirectories(target.getParent());
            Files.copy(source, target, StandardCopyOption.REPLACE_EXISTING);
            logger.debug("文件复制完成: {} -> {}", source, target);
            return true;
        }catch (Exception e) {
            logger.warn("文件复制失败: {} -> {}", source, target, e);
        }
        return false;
    }

    /*
     * 移动文件
     */
    public static Boolean moveFile(Path source, Path target) throws IOException {
        try {
            Files.move(source, target, StandardCopyOption.ATOMIC_MOVE);
            logger.debug("文件移动完成: {} -> {}", source, target);
            return true;
        } catch (Exception e) {
            logger.warn("文件移动失败: {} -> {}", source, target, e);
        }
        return false;
    }

    /*
     * 删除文件
     */
    public static Boolean deleteFile(Path file) throws IOException {
        try {
            Files.delete(file);
            logger.debug("文件删除完成: {}", file);
            return true;
        } catch (Exception e) {
            logger.warn("文件删除失败: {}", file, e);
        }
        return false;
    }

    /**
     * 递归删除目录
     */
    public static void deleteRecursively(Path directory) throws IOException {
        if (Files.exists(directory)) {
            try (Stream<Path> stream = Files.walk(directory)) {
                stream.sorted((a, b) -> b.compareTo(a))
                      .forEach(path -> {
                          try {
                              Files.delete(path);
                          } catch (IOException e) {
                              logger.warn("删除文件失败: {}", path, e);
                          }
                      });
            }
            logger.debug("目录删除完成: {}", directory);
        }
    }

    /**
     * 创建目录（如果不存在）
     */
    public static void createDirectoryIfNotExists(Path directory) throws IOException {
        if (!Files.exists(directory)) {
            Files.createDirectories(directory);
            logger.debug("目录创建完成: {}", directory);
        }
    }

    /**
     * 获取相对路径
     */
    public static String getRelativePath(Path base, Path path) {
        return base.relativize(path).toString().replace('\\', '/');
    }

    /**
     * 检查文件名是否匹配模式
     */
    public static boolean matchesPattern(String fileName, List<String> patterns) {
        if (patterns == null || patterns.isEmpty()) {
            return true;
        }

        return patterns.stream().anyMatch(pattern -> {
            // 简单的 glob 模式匹配
            String regex = pattern.replace(".", "\\.")
                                 .replace("*", ".*")
                                 .replace("?", ".");
            return fileName.matches(regex);
        });
    }
}
